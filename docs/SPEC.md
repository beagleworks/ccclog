# CHANGELOG Viewer 仕様書（共通）

この文書は共通仕様をまとめたものです。プロダクト固有仕様やパイプライン仕様は以下を参照してください。
- `docs/SPEC_CLAUDE.md`: Claude Code 固有仕様
- `docs/SPEC_CODEX.md`: OpenAI Codex 固有仕様
- `docs/SPEC_PIPELINE.md`: データ生成・CI/CD 仕様

---

## 1. 概要

### 1.1 目的
Claude Code / OpenAI Codex の変更履歴（CHANGELOG）を日本語/英語の並列テーブル形式で閲覧できる静的Webアプリケーション。

### 1.2 技術スタック
| 項目 | 技術 |
|------|------|
| フレームワーク | Astro 5.x（SSG） |
| 検索エンジン | Fuse.js 7.x |
| ビルドツール | tsx, TypeScript 5.x |
| パッケージマネージャー | pnpm |
| ホスティング | GitHub Pages |
| CI/CD | GitHub Actions |

---

## 2. プロダクト定義

| プロパティ | Claude Code | Codex |
|-----------|-------------|-------|
| `productId` | `claude-code` | `codex` |
| `basePath` | `/` | `/codex/` |
| `contentDir` | `content/` | `content/codex/` |
| `dataDir` | `src/data/` | `src/data/codex/` |
| `npmPackage` | `@anthropic-ai/claude-code` | （なし） |
| `github.owner` | `anthropics` | `openai` |
| `github.repo` | `claude-code` | `codex` |
| `github.tagPrefix` | `v` | `rust-v` |

---

## 3. 機能要件（共通）

### 3.1 データ表示

#### 3.1.1 月別グループ化
- 変更履歴を月単位でグループ化して表示
- 各月グループは折りたたみ可能（`<details>`要素）
- 最新月はデフォルトで展開、それ以外は折りたたみ
- 月ヘッダーにリリース数と変更項目数を表示

#### 3.1.2 バージョンセクション
- 各バージョンごとにセクションを表示
- 表示項目：
  - バージョン番号（例: 2.1.23）
  - 月内アップデート順序番号（例: | #3 - その月の3番目のリリース）
  - リリース日（日本語形式: 2026年1月29日）
  - 変更エントリテーブル
- 月内アップデート順序番号は、その月の何度目のアップデートかを示す（1から始まる連番）
- 月内のバージョンはリリース日降順（同日の場合はsemver降順）でソート

#### 3.1.3 テーブル形式
| 列 | 内容 |
|----|------|
| 日本語 | 変更内容の日本語説明 |
| English | 変更内容の英語説明 |

#### 3.1.4 エントリタイプの視覚的識別
変更内容の先頭キーワードに応じて左ボーダー色を変更：

| キーワード | 色 | カラーコード |
|-----------|-----|-------------|
| Added / Add / 追加 | 緑 | #3fb950 |
| Fixed / Fix / bugfixes / 修正 | オレンジ | #f0883e |
| Changed / Change / 変更 | 紫 | #a371f7 |
| Improved / Improve / 改善 | 青 | #79c0ff |
| Other / その他 | グレー | #8b949e |

**プレフィックス除外**
以下の形式のプレフィックスは判定時に除外される：
- `[Tag]` 形式（例: `[IDE]`, `[VSCode]`）
- `Tag:` 形式（例: `Bedrock:`, `Windows:`）

### 3.2 検索機能

#### 3.2.1 全文検索
- Fuse.js によるファジー検索
- 検索対象はモードにより日本語のみ/英語のみ/両方（デフォルトは両方）
- 検索閾値（threshold）: 0.3
- 位置非依存検索（ignoreLocation: true）

#### 3.2.2 検索UI
- 検索ボックス（プレースホルダー: 「検索... (日本語/English)」）
- クリアボタン（入力時に表示）
- 検索結果件数の表示
- 結果なし時のメッセージ表示

#### 3.2.3 検索結果の表示
- マッチしたエントリのみ表示
- マッチしないバージョン・月グループを非表示
- マッチ箇所のハイライト表示（黄色背景）
- 検索結果がある月グループは自動展開
- バッククォート内のテキストは `<code>` 表示を維持

#### 3.2.4 キーボード操作
- `Escape`キー: 検索クリア
- デバウンス: 150ms

#### 3.2.5 URLパラメータ
- `?q=検索語` でページ読み込み時に検索を実行
- `?mode=ja|en` で検索モードを指定（省略時は `both`）
- 両方の指定が可能: `?q=MCP&mode=ja`
- クリーンURL方針として、`both` の場合は `mode` を付与しない

#### 3.2.6 検索モード選択
- ユーザーは検索対象を以下から選択可能：
  - 「日本語のみ」: 日本語列（`ja`）のみを検索対象
  - 「原文のみ」: 英語列（`en`）のみを検索対象
  - 「両方」: 日本語・英語両方を検索対象（デフォルト）
- モード切り替えはセグメントコントロールUIで提供
- 選択されたモードは URLパラメータ（`?mode=ja|en`、`both`は省略）と sessionStorage で保持
  - 優先順位: URLパラメータ > sessionStorage > デフォルト（`both`）
  - sessionStorage は同一タブのみ保持（新しいタブ/ウィンドウには引き継がれない）
- 検索実行中にモードを切り替えると、現在のクエリで即座に再検索

#### 3.2.7 検索モード保持キー
プロダクト間での干渉を避けるため、sessionStorage のキーをプロダクト別に分離：
- Claude Code: `ccclog.searchMode.claude-code`
- Codex: `ccclog.searchMode.codex`

### 3.3 レスポンシブデザイン
- デスクトップ・モバイル両対応
- ブレークポイント: 768px
- モバイルでのフォントサイズ調整（iOS ズーム防止: 16px）

### 3.4 複数年対応

#### 3.4.1 年別ページ
- 動的ルーティング `[year].astro` により、年ごとのページを自動生成
- 対応年は各プロダクトの `contentDir` に存在する `CHANGELOG_*_JA.md` から自動検出
- トップページは最新年にリダイレクト

#### 3.4.2 年切り替えナビゲーション
- 年一覧は `contentDir` ディレクトリから動的に取得
- ハードコードを排除し、新年追加時の手動変更を不要に
- ヘッダーに年切り替えリンクを表示
- 現在表示中の年はアクティブ状態で強調表示
- クリックで年間を切り替え可能

---

## 4. データ仕様（共通）

### 4.1 入力データ形式
年ごとに分離されたMarkdownファイル（`CHANGELOG_{YEAR}_JA.md`）を使用する。

形式：
```markdown
## 2.1.23

| 日本語 | English |
|--------|---------|
| 変更内容（日本語） | Change description (English) |
| ... | ... |

## 2.1.22
...
```

### 4.2 生成データ

#### 4.2.1 年別JSONファイル
年ごとに分離されたJSONファイルを生成する（パスはプロダクトごとに異なる）。

```typescript
interface ChangelogData {
  generatedAt: string;        // ISO 8601形式の生成日時
  months: MonthGroup[];
}

interface MonthGroup {
  key: string;                // "2026-01"
  label: string;              // "2026年1月"
  versions: Version[];
}

interface Version {
  version: string;            // "2.1.23"
  releaseDate: string;        // "2026-01-29"
  releaseDateDisplay: string; // "2026年1月29日"
  entries: Entry[];
}

interface Entry {
  ja: string;                 // 日本語説明
  en: string;                 // 英語説明
}
```

#### 4.2.2 年別Markdownファイル
- `generated/CHANGELOG-{year}.md`（プロダクト別にサブディレクトリを持つ）

---

## 5. UI仕様

### 5.1 カラーパレット（ダークテーマ）

| 用途 | 変数名 | 値 |
|-----|--------|-----|
| 背景 | --color-bg | #0d1117 |
| 背景（二次） | --color-bg-secondary | #161b22 |
| ボーダー | --color-border | #30363d |
| テキスト | --color-text | #e6edf3 |
| テキスト（薄） | --color-text-muted | #8b949e |
| アクセント | --color-accent | #58a6ff |

### 5.2 フォント

| 用途 | フォントファミリー |
|-----|-------------------|
| 本文 | -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans JP', sans-serif |
| コード | 'SF Mono', 'Fira Code', 'Consolas', monospace |

### 5.3 レイアウト
- 最大幅: 1200px
- パディング: 2rem 1.5rem（デスクトップ）、1rem（モバイル）

### 5.4 フッター
- 著作権表示: © 2026 びーぐる(Beagle Works)
- ソーシャルリンク: X (Twitter) アイコン（著作権表示の後）
- 外部リンク: プロダクト固有リンク（詳細は各プロダクト仕様を参照）

---

## 6. 制約事項

### 6.1 既知の制限
- GitHub API レート制限: 認証なしで60リクエスト/時間
- 検索はクライアントサイドで実行されるため、データ量が増えるとパフォーマンスに影響

### 6.2 前提条件
- `CHANGELOG_{YEAR}_JA.md` が指定のMarkdown形式に従っていること
- リポジトリやタグ形式などの前提は各プロダクト仕様に準拠すること

---

## 7. セキュリティ要件

### 7.1 XSS/HTML注入対策
GitHub CHANGELOG 等の外部データを HTML として表示する際は、以下のルールに従う：

| 処理順序 | 内容 |
|---------|------|
| 1 | HTML特殊文字（`<`, `>`, `&`, `"`, `'`）をエスケープ |
| 2 | バッククォート（`` ` ``）で囲まれた部分のみ `<code>` タグに変換 |

**対象箇所:**
- `VersionSection.astro`: テーブルセル表示
- `index.astro`: 検索結果のハイライト表示

### 7.2 コマンドインジェクション対策
外部データを含むコマンドを実行する際は、シェルを経由せずに直接実行する：

| 禁止 | 推奨 |
|------|------|
| `execSync(\`cmd "${data}"\`)` | `execFileSync('cmd', [data])` |

**対象箇所:**
- `sync-versions.ts`: Claude CLI 呼び出し
- `retranslate.ts`: Claude CLI 呼び出し

---

## 8. 変更履歴

| 日付 | バージョン | 変更内容 |
|-----|-----------|---------|
| 2026-02-04 | 3.0.0 | マルチプロダクト対応（OpenAI Codex CHANGELOG 追加） |
| 2026-01-31 | 2.2.0 | 検索時のcode表示維持、月内ソート、Markdownエスケープ、年別ページ動的化 |
| 2026-01-31 | 2.1.3 | セキュリティ要件を追加（XSS対策、コマンドインジェクション対策） |
| 2026-01-30 | 2.1.2 | 翻訳モデルを Claude Sonnet に明示的に指定（品質向上） |
| 2026-01-30 | 2.1.1 | ソースデータを `content/` ディレクトリに移動 |
| 2026-01-30 | 2.1.0 | 「（翻訳待ち）」エントリの再翻訳機能を追加 |
| 2026-01-30 | 2.0.0 | 新バージョン検出時に Claude Code CLI で自動翻訳する機能を追加 |
| 2026-01-30 | 1.4.0 | 新バージョン自動検出機能を追加（npm レジストリから未記載バージョンを検出し CHANGELOG に自動追記） |
| 2026-01-30 | 1.3.1 | フッターXアイコン位置変更、bugfixes分類対応 |
| 2026-01-29 | 1.3.0 | エントリタイプ分類改善、GitHubタグ取得追加、デプロイスケジュール変更、フッター改善 |
| 2026-01-29 | 1.2.0 | npm レジストリからのリリース日取得に変更（最も正確な公開日） |
| 2026-01-29 | 1.1.0 | 複数年対応を追加（2025年ページ、年切り替えナビゲーション） |
| 2026-01-29 | 1.0.0 | 初版作成 |
