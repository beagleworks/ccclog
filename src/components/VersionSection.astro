---
import { getEntryType, type Entry } from '../lib/get-entry-type';
import { formatEntryHtml } from '../lib/entry-html';
import { formatXCopyText } from '../lib/x-copy-format';

interface Props {
  version: string;
  releaseDate: string;
  releaseDateDisplay: string;
  entries: Entry[];
  orderInMonth: number;
  product?: 'claude-code' | 'codex';
}

const { version, releaseDateDisplay, entries, orderInMonth, product = 'claude-code' } = Astro.props;
const productName = product === 'codex' ? 'OpenAI Codex' : 'Claude Code';
---

<article class="version-section" id={`v${version}`}>
  <header class="version-header">
    <h3 class="version-title">
      <a href={`#v${version}`}>v{version}</a>
      <span class="order-badge">| #{orderInMonth}</span>
    </h3>
    <time class="version-date">{releaseDateDisplay}</time>
  </header>

  <div class="entries-table-wrapper">
    <table class="entries-table">
      <thead>
        <tr>
          <th>日本語</th>
          <th>English</th>
        </tr>
      </thead>
      <tbody>
        {entries.map((entry) => {
          const entryType = getEntryType(entry, product);
          return (
            <tr class={`entry-row ${entryType}`} data-ja={entry.ja} data-en={entry.en}>
              <td class="entry-ja" set:html={formatEntryHtml(entry.ja, { product, language: 'ja' })} />
              <td class="entry-en" set:html={formatEntryHtml(entry.en, { product, language: 'en' })} />
            </tr>
          );
        })}
      </tbody>
    </table>
  </div>

  <div class="plain-block">
    <pre class="plain-text">{formatXCopyText({ productName, version, entries, language: 'ja' })}</pre>
  </div>
</article>

<style>
  .version-section {
    background-color: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    margin-bottom: 1rem;
    overflow: hidden;
  }

  .version-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
    background-color: rgba(255, 255, 255, 0.02);
    border-bottom: 1px solid var(--color-border);
  }

  .version-title {
    font-size: 1.1rem;
    font-weight: 600;
  }

  .version-title a {
    color: var(--color-text);
  }

  .version-title a:hover {
    color: var(--color-accent);
    text-decoration: none;
  }

  .order-badge {
    color: var(--color-text-muted);
    font-weight: 400;
    font-size: 0.9em;
    margin-left: 0.5rem;
  }

  .version-date {
    color: var(--color-text-muted);
    font-size: 0.875rem;
  }

  .entries-table-wrapper {
    overflow-x: auto;
  }

  .plain-block {
    display: none;
    padding: 1rem;
  }

  .plain-text {
    margin: 0;
    font-family: var(--font-sans);
    font-size: 0.95rem;
    line-height: 1.75;
    white-space: pre-wrap;
    word-break: break-word;
  }

  .entries-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
  }

  .entries-table th,
  .entries-table td {
    padding: 0.75rem 1rem;
    text-align: left;
    border-bottom: 1px solid var(--color-border);
    vertical-align: top;
  }

  .entries-table th {
    background-color: rgba(255, 255, 255, 0.02);
    font-weight: 500;
    color: var(--color-text-muted);
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .entries-table th:first-child {
    width: 50%;
  }

  .entries-table tbody tr:last-child td {
    border-bottom: none;
  }

  .entries-table tbody tr:hover {
    background-color: rgba(255, 255, 255, 0.02);
  }

  /* エントリタイプによる左ボーダー色 */
  .entry-row.added td:first-child {
    border-left: 3px solid var(--color-added);
    padding-left: calc(1rem - 3px);
  }

  .entry-row.fixed td:first-child {
    border-left: 3px solid var(--color-fixed);
    padding-left: calc(1rem - 3px);
  }

  .entry-row.changed td:first-child {
    border-left: 3px solid var(--color-changed);
    padding-left: calc(1rem - 3px);
  }

  .entry-row.improved td:first-child {
    border-left: 3px solid var(--color-improved);
    padding-left: calc(1rem - 3px);
  }

  .entry-row.other td:first-child {
    border-left: 3px solid var(--color-other);
    padding-left: calc(1rem - 3px);
  }

  /* 表示モード: 日本語のみ（英語列を非表示） */
  :global(#changelog-list.display-ja) .entries-table th:nth-child(2),
  :global(#changelog-list.display-ja) .entry-en { display: none; }

  :global(#changelog-list.display-ja) .entries-table th:first-child { width: 100%; }

  /* 表示モード: 原文のみ（日本語列を非表示） */
  :global(#changelog-list.display-en) .entries-table th:first-child,
  :global(#changelog-list.display-en) .entry-ja { display: none; }

  :global(#changelog-list.display-en) .entries-table th:nth-child(2) { width: 100%; }

  /* 表示形式: プレーン（テーブルを隠してプレーンテキストを表示） */
  :global(#changelog-list.plain-mode) .entries-table-wrapper { display: none; }
  :global(#changelog-list.plain-mode) .plain-block { display: block; }

  /* 原文のみ表示時: 左ボーダーを .entry-en に移動 */
  :global(#changelog-list.display-en) .entry-row.added td:first-child { border-left: none; padding-left: 1rem; }
  :global(#changelog-list.display-en) .entry-row.added .entry-en { border-left: 3px solid var(--color-added); padding-left: calc(1rem - 3px); }

  :global(#changelog-list.display-en) .entry-row.fixed td:first-child { border-left: none; padding-left: 1rem; }
  :global(#changelog-list.display-en) .entry-row.fixed .entry-en { border-left: 3px solid var(--color-fixed); padding-left: calc(1rem - 3px); }

  :global(#changelog-list.display-en) .entry-row.changed td:first-child { border-left: none; padding-left: 1rem; }
  :global(#changelog-list.display-en) .entry-row.changed .entry-en { border-left: 3px solid var(--color-changed); padding-left: calc(1rem - 3px); }

  :global(#changelog-list.display-en) .entry-row.improved td:first-child { border-left: none; padding-left: 1rem; }
  :global(#changelog-list.display-en) .entry-row.improved .entry-en { border-left: 3px solid var(--color-improved); padding-left: calc(1rem - 3px); }

  :global(#changelog-list.display-en) .entry-row.other td:first-child { border-left: none; padding-left: 1rem; }
  :global(#changelog-list.display-en) .entry-row.other .entry-en { border-left: 3px solid var(--color-other); padding-left: calc(1rem - 3px); }

  /* 検索ハイライト */
  :global(.highlight) {
    background-color: rgba(255, 220, 0, 0.3);
    padding: 0.1em 0;
    border-radius: 2px;
  }

  :global(.highlight-token) {
    background-color: rgba(255, 220, 0, 0.35);
    color: inherit;
    padding: 0 0.05em;
    border-radius: 2px;
  }

  /* 非表示状態 */
  .version-section.hidden {
    display: none;
  }

  .entry-row.hidden {
    display: none;
  }

  @media (max-width: 768px) {
    .entries-table th,
    .entries-table td {
      padding: 0.5rem 0.75rem;
      font-size: 0.85rem;
    }

    .version-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.25rem;
    }
  }
</style>
