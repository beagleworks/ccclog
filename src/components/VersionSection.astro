---
interface Entry {
  ja: string;
  en: string;
}

interface Props {
  version: string;
  releaseDate: string;
  releaseDateDisplay: string;
  entries: Entry[];
  orderInMonth: number;
}

const { version, releaseDateDisplay, entries, orderInMonth } = Astro.props;

/**
 * HTML特殊文字をエスケープ
 */
function escapeHtml(text: string): string {
  return text
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

/**
 * テキストを安全にフォーマット（HTMLエスケープ後にバッククォートを<code>に変換）
 */
function formatSafeHtml(text: string): string {
  const escaped = escapeHtml(text);
  return escaped.replace(/`([^`]+)`/g, '<code>$1</code>');
}

/**
 * エントリの種類を判定してバッジクラスを返す
 * 文中に動詞キーワードが含まれるかで判定（プレフィックス除去不要）
 */
function getEntryType(enText: string): string {
  const lowerEn = enText.toLowerCase();

  // Added / Add
  if (lowerEn.includes('added') || lowerEn.includes('add ')) return 'added';
  // Fixed / Fix / bugfixes / Reduced
  if (lowerEn.includes('fixed') || lowerEn.includes('fix ') || lowerEn.includes('bugfix') || lowerEn.includes('reduced')) return 'fixed';
  // Changed / Change / Merged / Moved / Updated / Removed / Deprecated
  if (lowerEn.includes('changed') || lowerEn.includes('change ') || lowerEn.includes('merged') || lowerEn.includes('moved') || lowerEn.includes('updated') || lowerEn.includes('removed') || lowerEn.includes('deprecated')) return 'changed';
  // Improved / Improve
  if (lowerEn.includes('improved') || lowerEn.includes('improve ')) return 'improved';
  // Enabled / Enable
  if (lowerEn.includes('enabled') || lowerEn.includes('enable ')) return 'added';
  return 'other';
}
---

<article class="version-section" id={`v${version}`}>
  <header class="version-header">
    <h3 class="version-title">
      <a href={`#v${version}`}>v{version}</a>
      <span class="order-badge">| #{orderInMonth}</span>
    </h3>
    <time class="version-date">{releaseDateDisplay}</time>
  </header>

  <div class="entries-table-wrapper">
    <table class="entries-table">
      <thead>
        <tr>
          <th>日本語</th>
          <th>English</th>
        </tr>
      </thead>
      <tbody>
        {entries.map((entry) => {
          const entryType = getEntryType(entry.en);
          return (
            <tr class={`entry-row ${entryType}`} data-ja={entry.ja} data-en={entry.en}>
              <td class="entry-ja" set:html={formatSafeHtml(entry.ja)} />
              <td class="entry-en" set:html={formatSafeHtml(entry.en)} />
            </tr>
          );
        })}
      </tbody>
    </table>
  </div>
</article>

<style>
  .version-section {
    background-color: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    margin-bottom: 1rem;
    overflow: hidden;
  }

  .version-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
    background-color: rgba(255, 255, 255, 0.02);
    border-bottom: 1px solid var(--color-border);
  }

  .version-title {
    font-size: 1.1rem;
    font-weight: 600;
  }

  .version-title a {
    color: var(--color-text);
  }

  .version-title a:hover {
    color: var(--color-accent);
    text-decoration: none;
  }

  .order-badge {
    color: var(--color-text-muted);
    font-weight: 400;
    font-size: 0.9em;
    margin-left: 0.5rem;
  }

  .version-date {
    color: var(--color-text-muted);
    font-size: 0.875rem;
  }

  .entries-table-wrapper {
    overflow-x: auto;
  }

  .entries-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
  }

  .entries-table th,
  .entries-table td {
    padding: 0.75rem 1rem;
    text-align: left;
    border-bottom: 1px solid var(--color-border);
    vertical-align: top;
  }

  .entries-table th {
    background-color: rgba(255, 255, 255, 0.02);
    font-weight: 500;
    color: var(--color-text-muted);
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .entries-table th:first-child {
    width: 50%;
  }

  .entries-table tbody tr:last-child td {
    border-bottom: none;
  }

  .entries-table tbody tr:hover {
    background-color: rgba(255, 255, 255, 0.02);
  }

  /* エントリタイプによる左ボーダー色 */
  .entry-row.added td:first-child {
    border-left: 3px solid var(--color-added);
    padding-left: calc(1rem - 3px);
  }

  .entry-row.fixed td:first-child {
    border-left: 3px solid var(--color-fixed);
    padding-left: calc(1rem - 3px);
  }

  .entry-row.changed td:first-child {
    border-left: 3px solid var(--color-changed);
    padding-left: calc(1rem - 3px);
  }

  .entry-row.improved td:first-child {
    border-left: 3px solid var(--color-improved);
    padding-left: calc(1rem - 3px);
  }

  .entry-row.other td:first-child {
    border-left: 3px solid var(--color-other);
    padding-left: calc(1rem - 3px);
  }

  /* 検索ハイライト */
  :global(.highlight) {
    background-color: rgba(255, 220, 0, 0.3);
    padding: 0.1em 0;
    border-radius: 2px;
  }

  /* 非表示状態 */
  .version-section.hidden {
    display: none;
  }

  .entry-row.hidden {
    display: none;
  }

  @media (max-width: 768px) {
    .entries-table th,
    .entries-table td {
      padding: 0.5rem 0.75rem;
      font-size: 0.85rem;
    }

    .version-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.25rem;
    }
  }
</style>
