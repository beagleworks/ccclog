---
interface Entry {
  ja: string;
  en: string;
}

interface Props {
  version: string;
  releaseDate: string;
  releaseDateDisplay: string;
  entries: Entry[];
  orderInMonth: number;
}

const { version, releaseDateDisplay, entries, orderInMonth } = Astro.props;

/**
 * エントリの種類を判定してバッジクラスを返す
 * [VSCode] や [Windows] などのプレフィックスは除外して動詞を認識する
 */
function getEntryType(text: string): string {
  // [Tag] 形式のプレフィックスを除去
  const cleanedText = text.replace(/^\[.*?\]\s*/, '');
  const lowerText = cleanedText.toLowerCase();

  // Added / Add
  if (lowerText.startsWith('added') || lowerText.startsWith('add ') || cleanedText.startsWith('追加')) return 'added';
  // Fixed / Fix / bugfixes
  if (lowerText.startsWith('fixed') || lowerText.startsWith('fix ') || lowerText.includes('bugfix') || cleanedText.startsWith('修正')) return 'fixed';
  // Changed / Change
  if (lowerText.startsWith('changed') || lowerText.startsWith('change ') || cleanedText.startsWith('変更')) return 'changed';
  // Improved / Improve
  if (lowerText.startsWith('improved') || lowerText.startsWith('improve ') || cleanedText.startsWith('改善')) return 'improved';
  // Enabled / Enable
  if (lowerText.startsWith('enabled') || lowerText.startsWith('enable ') || cleanedText.startsWith('有効化')) return 'added';
  // Removed / Remove
  if (lowerText.startsWith('removed') || lowerText.startsWith('remove ') || cleanedText.startsWith('削除')) return 'changed';
  // Deprecated / Deprecate
  if (lowerText.startsWith('deprecated') || lowerText.startsWith('deprecate ') || cleanedText.startsWith('非推奨')) return 'changed';
  return 'other';
}
---

<article class="version-section" id={`v${version}`}>
  <header class="version-header">
    <h3 class="version-title">
      <a href={`#v${version}`}>v{version}</a>
      <span class="order-badge">| #{orderInMonth}</span>
    </h3>
    <time class="version-date">{releaseDateDisplay}</time>
  </header>

  <div class="entries-table-wrapper">
    <table class="entries-table">
      <thead>
        <tr>
          <th>日本語</th>
          <th>English</th>
        </tr>
      </thead>
      <tbody>
        {entries.map((entry) => {
          const entryType = getEntryType(entry.en);
          return (
            <tr class={`entry-row ${entryType}`} data-ja={entry.ja} data-en={entry.en}>
              <td class="entry-ja" set:html={entry.ja.replace(/`([^`]+)`/g, '<code>$1</code>')} />
              <td class="entry-en" set:html={entry.en.replace(/`([^`]+)`/g, '<code>$1</code>')} />
            </tr>
          );
        })}
      </tbody>
    </table>
  </div>
</article>

<style>
  .version-section {
    background-color: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    margin-bottom: 1rem;
    overflow: hidden;
  }

  .version-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
    background-color: rgba(255, 255, 255, 0.02);
    border-bottom: 1px solid var(--color-border);
  }

  .version-title {
    font-size: 1.1rem;
    font-weight: 600;
  }

  .version-title a {
    color: var(--color-text);
  }

  .version-title a:hover {
    color: var(--color-accent);
    text-decoration: none;
  }

  .order-badge {
    color: var(--color-text-muted);
    font-weight: 400;
    font-size: 0.9em;
    margin-left: 0.5rem;
  }

  .version-date {
    color: var(--color-text-muted);
    font-size: 0.875rem;
  }

  .entries-table-wrapper {
    overflow-x: auto;
  }

  .entries-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
  }

  .entries-table th,
  .entries-table td {
    padding: 0.75rem 1rem;
    text-align: left;
    border-bottom: 1px solid var(--color-border);
    vertical-align: top;
  }

  .entries-table th {
    background-color: rgba(255, 255, 255, 0.02);
    font-weight: 500;
    color: var(--color-text-muted);
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .entries-table th:first-child {
    width: 50%;
  }

  .entries-table tbody tr:last-child td {
    border-bottom: none;
  }

  .entries-table tbody tr:hover {
    background-color: rgba(255, 255, 255, 0.02);
  }

  /* エントリタイプによる左ボーダー色 */
  .entry-row.added td:first-child {
    border-left: 3px solid var(--color-added);
    padding-left: calc(1rem - 3px);
  }

  .entry-row.fixed td:first-child {
    border-left: 3px solid var(--color-fixed);
    padding-left: calc(1rem - 3px);
  }

  .entry-row.changed td:first-child {
    border-left: 3px solid var(--color-changed);
    padding-left: calc(1rem - 3px);
  }

  .entry-row.improved td:first-child {
    border-left: 3px solid var(--color-improved);
    padding-left: calc(1rem - 3px);
  }

  .entry-row.other td:first-child {
    border-left: 3px solid var(--color-other);
    padding-left: calc(1rem - 3px);
  }

  /* 検索ハイライト */
  :global(.highlight) {
    background-color: rgba(255, 220, 0, 0.3);
    padding: 0.1em 0;
    border-radius: 2px;
  }

  /* 非表示状態 */
  .version-section.hidden {
    display: none;
  }

  .entry-row.hidden {
    display: none;
  }

  @media (max-width: 768px) {
    .entries-table th,
    .entries-table td {
      padding: 0.5rem 0.75rem;
      font-size: 0.85rem;
    }

    .version-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.25rem;
    }
  }
</style>
