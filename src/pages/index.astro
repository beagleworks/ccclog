---
import BaseLayout from '../layouts/BaseLayout.astro';
import SearchBox from '../components/SearchBox.astro';
import MonthGroup from '../components/MonthGroup.astro';
import changelogData from '../data/changelog-2026.json';

const { months, generatedAt } = changelogData;
const generatedDate = new Date(generatedAt).toLocaleString('ja-JP', {
  timeZone: 'Asia/Tokyo',
  year: 'numeric',
  month: 'long',
  day: 'numeric',
  hour: '2-digit',
  minute: '2-digit',
});
---

<BaseLayout title="Claude Code CHANGELOG Viewer" currentYear="2026">
  <SearchBox />

  <div class="info-bar">
    <span class="generated-at">最終更新: {generatedDate}</span>
  </div>

  <div id="changelog-list">
    {months.map((month, index) => (
      <MonthGroup
        monthKey={month.key}
        label={month.label}
        versions={month.versions}
        defaultOpen={index === 0}
      />
    ))}
  </div>

  <div id="no-results" class="no-results" hidden>
    <p>検索結果が見つかりませんでした。</p>
    <p>別のキーワードで検索してみてください。</p>
  </div>
</BaseLayout>

<script>
  import Fuse from 'fuse.js';

  interface Entry {
    ja: string;
    en: string;
  }

  interface Version {
    version: string;
    releaseDate: string;
    releaseDateDisplay: string;
    entries: Entry[];
  }

  interface SearchableEntry {
    version: string;
    monthKey: string;
    entryIndex: number;
    ja: string;
    en: string;
  }

  // DOM要素を取得
  const searchInput = document.getElementById('search-input') as HTMLInputElement;
  const clearButton = document.getElementById('clear-search') as HTMLButtonElement;
  const searchStats = document.getElementById('search-stats') as HTMLDivElement;
  const noResults = document.getElementById('no-results') as HTMLDivElement;

  // 検索用データを準備
  const searchableEntries: SearchableEntry[] = [];
  const monthGroups = document.querySelectorAll('.month-group');
  const versionSections = document.querySelectorAll('.version-section');

  monthGroups.forEach((group) => {
    const monthKey = group.getAttribute('data-month') || '';
    const sections = group.querySelectorAll('.version-section');

    sections.forEach((section) => {
      const version = section.id.replace('v', '');
      const rows = section.querySelectorAll('.entry-row');

      rows.forEach((row, entryIndex) => {
        const ja = (row as HTMLElement).dataset.ja || '';
        const en = (row as HTMLElement).dataset.en || '';
        searchableEntries.push({ version, monthKey, entryIndex, ja, en });
      });
    });
  });

  // Fuse.jsインスタンスを作成
  const fuse = new Fuse(searchableEntries, {
    keys: ['ja', 'en'],
    threshold: 0.3,
    ignoreLocation: true,
    includeMatches: true,
  });

  // 検索結果をハイライト
  function highlightText(element: HTMLElement, matches: Fuse.FuseResultMatch[] | undefined, key: string) {
    if (!matches) return;

    const match = matches.find((m) => m.key === key);
    if (!match || !match.indices || match.indices.length === 0) return;

    const text = element.textContent || '';
    let result = '';
    let lastIndex = 0;

    // インデックスをソートして処理
    const sortedIndices = [...match.indices].sort((a, b) => a[0] - b[0]);

    for (const [start, end] of sortedIndices) {
      result += escapeHtml(text.slice(lastIndex, start));
      result += `<span class="highlight">${escapeHtml(text.slice(start, end + 1))}</span>`;
      lastIndex = end + 1;
    }
    result += escapeHtml(text.slice(lastIndex));

    element.innerHTML = result;
  }

  function escapeHtml(text: string): string {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // 検索を実行
  function performSearch(query: string) {
    const trimmedQuery = query.trim();

    // 検索クリアボタンの表示制御
    clearButton.hidden = !trimmedQuery;

    if (!trimmedQuery) {
      // 検索クリア: すべて表示
      monthGroups.forEach((group) => group.classList.remove('hidden'));
      versionSections.forEach((section) => {
        section.classList.remove('hidden');
        const rows = section.querySelectorAll('.entry-row');
        rows.forEach((row) => {
          row.classList.remove('hidden');
          // ハイライトをリセット
          const jaCell = row.querySelector('.entry-ja') as HTMLElement;
          const enCell = row.querySelector('.entry-en') as HTMLElement;
          if (jaCell) jaCell.innerHTML = formatCode((row as HTMLElement).dataset.ja || '');
          if (enCell) enCell.innerHTML = formatCode((row as HTMLElement).dataset.en || '');
        });
      });
      searchStats.hidden = true;
      noResults.hidden = true;
      return;
    }

    // 検索実行
    const results = fuse.search(trimmedQuery);
    const matchedVersions = new Set<string>();
    const matchedMonths = new Set<string>();
    const matchedEntries = new Map<string, Set<number>>();

    results.forEach((result) => {
      const { version, monthKey, entryIndex } = result.item;
      matchedVersions.add(version);
      matchedMonths.add(monthKey);

      const key = `v${version}`;
      if (!matchedEntries.has(key)) {
        matchedEntries.set(key, new Set());
      }
      matchedEntries.get(key)!.add(entryIndex);
    });

    // UIを更新
    let visibleEntryCount = 0;

    monthGroups.forEach((group) => {
      const monthKey = group.getAttribute('data-month') || '';
      if (matchedMonths.has(monthKey)) {
        group.classList.remove('hidden');
        // 折りたたみを開く
        const details = group.querySelector('details');
        if (details) details.open = true;
      } else {
        group.classList.add('hidden');
      }
    });

    versionSections.forEach((section) => {
      const version = section.id;
      const versionNum = version.replace('v', '');

      if (matchedVersions.has(versionNum)) {
        section.classList.remove('hidden');
        const rows = section.querySelectorAll('.entry-row');
        const matchedIndices = matchedEntries.get(version) || new Set();

        rows.forEach((row, idx) => {
          if (matchedIndices.has(idx)) {
            row.classList.remove('hidden');
            visibleEntryCount++;

            // ハイライトを適用
            const matchResult = results.find(
              (r) => r.item.version === versionNum && r.item.entryIndex === idx
            );
            const jaCell = row.querySelector('.entry-ja') as HTMLElement;
            const enCell = row.querySelector('.entry-en') as HTMLElement;

            // まずテキストをリセット
            if (jaCell) jaCell.innerHTML = formatCode((row as HTMLElement).dataset.ja || '');
            if (enCell) enCell.innerHTML = formatCode((row as HTMLElement).dataset.en || '');

            // ハイライトを適用
            if (matchResult?.matches) {
              if (jaCell) highlightText(jaCell, matchResult.matches, 'ja');
              if (enCell) highlightText(enCell, matchResult.matches, 'en');
            }
          } else {
            row.classList.add('hidden');
          }
        });
      } else {
        section.classList.add('hidden');
      }
    });

    // 検索統計を表示
    if (visibleEntryCount > 0) {
      searchStats.innerHTML = `<span class="match-count">${visibleEntryCount}</span> 件の結果`;
      searchStats.hidden = false;
      noResults.hidden = true;
    } else {
      searchStats.hidden = true;
      noResults.hidden = false;
    }
  }

  // HTML特殊文字をエスケープ
  function escapeHtmlForFormat(text: string): string {
    return text
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  // バッククォートをcodeタグに変換（HTMLエスケープ後）
  function formatCode(text: string): string {
    const escaped = escapeHtmlForFormat(text);
    return escaped.replace(/`([^`]+)`/g, '<code>$1</code>');
  }

  // イベントリスナーを設定
  let debounceTimer: number;

  searchInput.addEventListener('input', () => {
    clearTimeout(debounceTimer);
    debounceTimer = window.setTimeout(() => {
      performSearch(searchInput.value);
    }, 150);
  });

  clearButton.addEventListener('click', () => {
    searchInput.value = '';
    performSearch('');
    searchInput.focus();
  });

  // Escapeキーで検索をクリア
  searchInput.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      searchInput.value = '';
      performSearch('');
    }
  });

  // ページ読み込み時にURLパラメータから検索クエリを復元
  const urlParams = new URLSearchParams(window.location.search);
  const initialQuery = urlParams.get('q');
  if (initialQuery) {
    searchInput.value = initialQuery;
    performSearch(initialQuery);
  }
</script>

<style>
  .info-bar {
    display: flex;
    justify-content: flex-end;
    margin-bottom: 1.5rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--color-border);
  }

  .generated-at {
    color: var(--color-text-muted);
    font-size: 0.8rem;
  }

  .no-results {
    text-align: center;
    padding: 3rem 1rem;
    color: var(--color-text-muted);
  }

  .no-results p {
    margin-bottom: 0.5rem;
  }

  .no-results:not([hidden]) {
    display: block;
  }
</style>
