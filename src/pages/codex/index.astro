---
/**
 * Codex トップページ
 * 最新年のコンテンツを直接表示（リダイレクトなし）
 */
import { readdirSync } from 'node:fs';
import { join } from 'node:path';
import ChangelogPage from '../../components/ChangelogPage.astro';
import BaseLayout from '../../layouts/BaseLayout.astro';

// content/codex/ ディレクトリから年を自動検出
const contentDir = join(process.cwd(), 'content', 'codex');
let years: string[] = [];

try {
  const files = readdirSync(contentDir);
  years = files
    .filter((f) => /^CHANGELOG_(\d{4})_JA\.md$/.test(f))
    .map((f) => f.match(/^CHANGELOG_(\d{4})_JA\.md$/)![1])
    .sort()
    .reverse();
} catch {
  // ディレクトリが存在しない場合は空配列のまま
}

// 最新年のデータを取得
const latestYear = years[0];
let months: any[] = [];
let generatedAt = new Date().toISOString();

if (latestYear) {
  try {
    const changelogData = await import(`../../data/codex/changelog-${latestYear}.json`);
    months = changelogData.months;
    generatedAt = changelogData.generatedAt;
  } catch {
    // データが存在しない場合は空配列のまま
  }
}
---

{years.length > 0 && months.length > 0 ? (
  <ChangelogPage
    year={latestYear}
    years={years}
    months={months}
    generatedAt={generatedAt}
    product="codex"
  />
) : (
  <BaseLayout title="OpenAI Codex CHANGELOG Viewer" years={[]} product="codex">
    <div class="no-data">
      <p>データがありません。</p>
    </div>
  </BaseLayout>
)}

<style>
  .no-data {
    text-align: center;
    padding: 3rem 1rem;
    color: var(--color-text-muted);
  }
</style>
